<script>
    // ðŸ“Œ Google Apps Script ì›¹ì•± URL ìž…ë ¥
    const GAS_URL = "ì—¬ê¸°ì—_ì›¹ì•±_URL_ë¶™ì—¬ë„£ê¸°";

    // ì „ì—­ ë°ì´í„°
    let educationData = {
        courses: [],
        students: {},
        attendance: {},
        courseIdCounter: 1
    };

    // === Google Sheet ì €ìž¥ ===
    function saveDataToServer() {
        fetch(GAS_URL, {
            method: "POST",
            body: JSON.stringify(educationData)
        })
        .then(res => res.json())
        .then(res => {
            console.log("âœ… Google Sheet ì €ìž¥ ì™„ë£Œ", res);
        })
        .catch(err => console.error("âŒ ì €ìž¥ ì‹¤íŒ¨:", err));
    }

    // === Google Sheet ë¶ˆëŸ¬ì˜¤ê¸° ===
    function loadDataFromServer(callback) {
        fetch(GAS_URL)
        .then(res => res.json())
        .then(data => {
            if (data && data.courses) {
                educationData = data;
                console.log("âœ… Google Sheet ë°ì´í„° ë¡œë“œ ì™„ë£Œ", data);
            } else {
                console.warn("âš ï¸ Google Sheetì— ì €ìž¥ëœ ë°ì´í„° ì—†ìŒ");
            }
            if (callback) callback();
        })
        .catch(err => console.error("âŒ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err));
    }

    // === ê³¼ì • ì¶”ê°€ ===
    function addCourse() {
        const name = document.getElementById('course-name').value;
        const date = document.getElementById('course-date').value;

        if (!name || !date) {
            alert('ê³¼ì •ëª…ê³¼ êµìœ¡ ë‚ ì§œë¥¼ ìž…ë ¥í•˜ì„¸ìš”.');
            return;
        }

        const course = {
            id: educationData.courseIdCounter++,
            name: name,
            date: date,
            students: []
        };

        educationData.courses.push(course);
        educationData.students[course.id] = [];
        educationData.attendance[course.id] = {};

        document.getElementById('course-name').value = '';
        document.getElementById('course-date').value = '';

        updateCourseList();
        saveDataToServer();
        alert('ê³¼ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    // === ê³¼ì • ëª©ë¡ ê°±ì‹  ===
    function updateCourseList() {
        const tbody = document.getElementById('course-list');
        if (!tbody) return;

        tbody.innerHTML = '';

        educationData.courses.forEach(course => {
            const row = tbody.insertRow();
            const studentCount = educationData.students[course.id] ? educationData.students[course.id].length : 0;
            row.innerHTML = `
                <td>${course.id}</td>
                <td>${course.name}</td>
                <td>${course.date}</td>
                <td>${studentCount}ëª…</td>
                <td>
                    <button class="btn btn-danger" onclick="deleteCourse(${course.id})">ì‚­ì œ</button>
                </td>
            `;
        });
    }

    // === ê³¼ì • ì‚­ì œ ===
    function deleteCourse(courseId) {
        if (!confirm('ì •ë§ë¡œ ì´ ê³¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        educationData.courses = educationData.courses.filter(course => course.id !== courseId);
        delete educationData.students[courseId];
        delete educationData.attendance[courseId];

        updateCourseList();
        updateCourseSelect();
        saveDataToServer();
    }

    // === êµìœ¡ìƒ ì¶”ê°€ ===
    function addStudentManually() {
        const courseId = document.getElementById('select-course').value;
        const name = document.getElementById('manual-name').value.trim();
        const employeeId = document.getElementById('manual-employee-id').value.trim();

        if (!courseId) {
            alert('ë¨¼ì € ê³¼ì •ì„ ì„ íƒí•˜ì„¸ìš”.');
            return;
        }
        if (!name || !employeeId) {
            alert('ì´ë¦„ê³¼ ì‚¬ë²ˆì„ ëª¨ë‘ ìž…ë ¥í•˜ì„¸ìš”.');
            return;
        }
        if (educationData.attendance[courseId] && educationData.attendance[courseId][employeeId]) {
            alert('ì´ë¯¸ ë“±ë¡ëœ ì‚¬ë²ˆìž…ë‹ˆë‹¤.');
            return;
        }

        if (!educationData.students[courseId]) educationData.students[courseId] = [];
        if (!educationData.attendance[courseId]) educationData.attendance[courseId] = {};

        educationData.students[courseId].push({ name, employeeId });
        educationData.attendance[courseId][employeeId] = {
            name,
            employeeId,
            checkinTime: null,
            checkoutTime: null
        };

        document.getElementById('manual-name').value = '';
        document.getElementById('manual-employee-id').value = '';

        updateAttendanceList();
        saveDataToServer();
        alert(`${name}(${employeeId}) êµìœ¡ìƒì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }

    // === ì¶œì„ ì²˜ë¦¬ ===
    function markAttendance() {
        const name = document.getElementById('student-name').value.trim();
        const employeeId = document.getElementById('student-id').value.trim();
        const type = document.getElementById('attendance-type').value;

        if (!name || !employeeId) {
            showAttendanceResult('ì´ë¦„ê³¼ ì‚¬ë²ˆì„ ëª¨ë‘ ìž…ë ¥í•˜ì„¸ìš”.', 'error');
            return;
        }

        const today = new Date().toISOString().split('T')[0];
        const todayCourse = educationData.courses.find(c => c.date === today);
        if (!todayCourse) {
            showAttendanceResult('ì˜¤ëŠ˜ ì§„í–‰ë˜ëŠ” êµìœ¡ê³¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
            return;
        }

        if (!educationData.attendance[todayCourse.id] || !educationData.attendance[todayCourse.id][employeeId]) {
            showAttendanceResult('ë“±ë¡ë˜ì§€ ì•Šì€ êµìœ¡ìƒìž…ë‹ˆë‹¤.', 'error');
            return;
        }

        const student = educationData.attendance[todayCourse.id][employeeId];
        if (student.name !== name) {
            showAttendanceResult('ì´ë¦„ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
            return;
        }

        const now = new Date();
        if (type === 'checkin') {
            if (student.checkinTime) {
                showAttendanceResult('ì´ë¯¸ ìž…ì‹¤ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            student.checkinTime = now.toISOString();
            showAttendanceResult(`ìž…ì‹¤ ì™„ë£Œ! (${now.toLocaleTimeString('ko-KR')})`, 'success');
        } else {
            if (!student.checkinTime) {
                showAttendanceResult('ìž…ì‹¤ ì²˜ë¦¬ê°€ ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            if (student.checkoutTime) {
                showAttendanceResult('ì´ë¯¸ í‡´ì‹¤ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            student.checkoutTime = now.toISOString();
            showAttendanceResult(`í‡´ì‹¤ ì™„ë£Œ! (${now.toLocaleTimeString('ko-KR')})`, 'success');
        }

        document.getElementById('student-name').value = '';
        document.getElementById('student-id').value = '';

        saveDataToServer();
    }

    // === ì¶œì„ ê²°ê³¼ UI ===
    function showAttendanceResult(message, type) {
        const resultDiv = document.getElementById('attendance-result');
        resultDiv.className = `attendance-status status-${type}`;
        resultDiv.textContent = message;
        setTimeout(() => {
            resultDiv.textContent = '';
            resultDiv.className = '';
        }, 3000);
    }

    // íŽ˜ì´ì§€ ë¡œë“œ ì‹œ Google Sheet ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    document.addEventListener('DOMContentLoaded', () => {
        loadDataFromServer(() => {
            updateCourseList();
            updateCourseSelect();
            findTodayCourse();
        });
    });
</script>
