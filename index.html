<script>
    // 📌 Google Apps Script 웹앱 URL 입력
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyE1-satUK9FuhoHa0JqTfjtYvN08puv1-w47qkopei9RHxKom5GyUr6gCUSQ1Y43aqug/exec";

    // 전역 데이터
    let educationData = {
        courses: [],
        students: {},
        attendance: {},
        courseIdCounter: 1
    };

    // === Google Sheet 저장 ===
    function saveDataToServer() {
        fetch(GAS_URL, {
            method: "POST",
            body: JSON.stringify(educationData)
        })
        .then(res => res.json())
        .then(res => {
            console.log("✅ Google Sheet 저장 완료", res);
        })
        .catch(err => console.error("❌ 저장 실패:", err));
    }

    // === Google Sheet 불러오기 ===
    function loadDataFromServer(callback) {
        fetch(GAS_URL)
        .then(res => res.json())
        .then(data => {
            if (data && data.courses) {
                educationData = data;
                console.log("✅ Google Sheet 데이터 로드 완료", data);
            } else {
                console.warn("⚠️ Google Sheet에 저장된 데이터 없음");
            }
            if (callback) callback();
        })
        .catch(err => console.error("❌ 불러오기 실패:", err));
    }

    // === 과정 추가 ===
    function addCourse() {
        const name = document.getElementById('course-name').value;
        const date = document.getElementById('course-date').value;

        if (!name || !date) {
            alert('과정명과 교육 날짜를 입력하세요.');
            return;
        }

        const course = {
            id: educationData.courseIdCounter++,
            name: name,
            date: date,
            students: []
        };

        educationData.courses.push(course);
        educationData.students[course.id] = [];
        educationData.attendance[course.id] = {};

        document.getElementById('course-name').value = '';
        document.getElementById('course-date').value = '';

        updateCourseList();
        saveDataToServer();
        alert('과정이 추가되었습니다.');
    }

    // === 과정 목록 갱신 ===
    function updateCourseList() {
        const tbody = document.getElementById('course-list');
        if (!tbody) return;

        tbody.innerHTML = '';

        educationData.courses.forEach(course => {
            const row = tbody.insertRow();
            const studentCount = educationData.students[course.id] ? educationData.students[course.id].length : 0;
            row.innerHTML = `
                <td>${course.id}</td>
                <td>${course.name}</td>
                <td>${course.date}</td>
                <td>${studentCount}명</td>
                <td>
                    <button class="btn btn-danger" onclick="deleteCourse(${course.id})">삭제</button>
                </td>
            `;
        });
    }

    // === 과정 삭제 ===
    function deleteCourse(courseId) {
        if (!confirm('정말로 이 과정을 삭제하시겠습니까?')) return;

        educationData.courses = educationData.courses.filter(course => course.id !== courseId);
        delete educationData.students[courseId];
        delete educationData.attendance[courseId];

        updateCourseList();
        updateCourseSelect();
        saveDataToServer();
    }

    // === 교육생 추가 ===
    function addStudentManually() {
        const courseId = document.getElementById('select-course').value;
        const name = document.getElementById('manual-name').value.trim();
        const employeeId = document.getElementById('manual-employee-id').value.trim();

        if (!courseId) {
            alert('먼저 과정을 선택하세요.');
            return;
        }
        if (!name || !employeeId) {
            alert('이름과 사번을 모두 입력하세요.');
            return;
        }
        if (educationData.attendance[courseId] && educationData.attendance[courseId][employeeId]) {
            alert('이미 등록된 사번입니다.');
            return;
        }

        if (!educationData.students[courseId]) educationData.students[courseId] = [];
        if (!educationData.attendance[courseId]) educationData.attendance[courseId] = {};

        educationData.students[courseId].push({ name, employeeId });
        educationData.attendance[courseId][employeeId] = {
            name,
            employeeId,
            checkinTime: null,
            checkoutTime: null
        };

        document.getElementById('manual-name').value = '';
        document.getElementById('manual-employee-id').value = '';

        updateAttendanceList();
        saveDataToServer();
        alert(`${name}(${employeeId}) 교육생이 추가되었습니다.`);
    }

    // === 출석 처리 ===
    function markAttendance() {
        const name = document.getElementById('student-name').value.trim();
        const employeeId = document.getElementById('student-id').value.trim();
        const type = document.getElementById('attendance-type').value;

        if (!name || !employeeId) {
            showAttendanceResult('이름과 사번을 모두 입력하세요.', 'error');
            return;
        }

        const today = new Date().toISOString().split('T')[0];
        const todayCourse = educationData.courses.find(c => c.date === today);
        if (!todayCourse) {
            showAttendanceResult('오늘 진행되는 교육과정이 없습니다.', 'error');
            return;
        }

        if (!educationData.attendance[todayCourse.id] || !educationData.attendance[todayCourse.id][employeeId]) {
            showAttendanceResult('등록되지 않은 교육생입니다.', 'error');
            return;
        }

        const student = educationData.attendance[todayCourse.id][employeeId];
        if (student.name !== name) {
            showAttendanceResult('이름이 일치하지 않습니다.', 'error');
            return;
        }

        const now = new Date();
        if (type === 'checkin') {
            if (student.checkinTime) {
                showAttendanceResult('이미 입실 처리되었습니다.', 'error');
                return;
            }
            student.checkinTime = now.toISOString();
            showAttendanceResult(`입실 완료! (${now.toLocaleTimeString('ko-KR')})`, 'success');
        } else {
            if (!student.checkinTime) {
                showAttendanceResult('입실 처리가 되지 않았습니다.', 'error');
                return;
            }
            if (student.checkoutTime) {
                showAttendanceResult('이미 퇴실 처리되었습니다.', 'error');
                return;
            }
            student.checkoutTime = now.toISOString();
            showAttendanceResult(`퇴실 완료! (${now.toLocaleTimeString('ko-KR')})`, 'success');
        }

        document.getElementById('student-name').value = '';
        document.getElementById('student-id').value = '';

        saveDataToServer();
    }

    // === 출석 결과 UI ===
    function showAttendanceResult(message, type) {
        const resultDiv = document.getElementById('attendance-result');
        resultDiv.className = `attendance-status status-${type}`;
        resultDiv.textContent = message;
        setTimeout(() => {
            resultDiv.textContent = '';
            resultDiv.className = '';
        }, 3000);
    }

    // 페이지 로드 시 Google Sheet 데이터 불러오기
    document.addEventListener('DOMContentLoaded', () => {
        loadDataFromServer(() => {
            updateCourseList();
            updateCourseSelect();
            findTodayCourse();
        });
    });
</script>
