<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>인재육성부 교육 관리시스템</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header .badge {
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: inline-block;
            margin-top: 10px;
        }

        .system-selector {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }

        .system-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .system-btn.admin {
            background: #28a745;
            color: white;
        }

        .system-btn.student {
            background: #007bff;
            color: white;
        }

        .system-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .system-content {
            padding: 30px;
            min-height: 500px;
        }

        .hidden {
            display: none;
        }

        /* 관리자 시스템 스타일 */
        .admin-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .admin-nav-btn {
            padding: 10px 20px;
            border: none;
            background: #f8f9fa;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .admin-nav-btn.active {
            background: #28a745;
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4a90e2;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        /* 교육생 시스템 스타일 */
        .student-form {
            max-width: 500px;
            margin: 0 auto;
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .attendance-status {
            text-align: center;
            padding: 20px;
            margin-top: 20px;
            border-radius: 10px;
            font-weight: bold;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .current-time {
            text-align: center;
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 20px;
        }

        .file-upload {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background: #fafafa;
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            border-color: #4a90e2;
            background: #f0f7ff;
        }

        .file-upload input[type="file"] {
            margin: 10px 0;
        }

        .quick-access {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .quick-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 25px;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-size: 0.9rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .quick-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .course-info {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 25px;
            text-align: center;
        }

        .course-info h3 {
            color: #1976d2;
            margin-bottom: 5px;
        }

        .course-info p {
            color: #424242;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>인재육성부 교육 관리시스템</h1>
            <p>Education Management System</p>
            <div class="badge" id="system-badge">시스템 선택</div>
        </div>

        <div class="system-selector" id="system-selector">
            <button class="system-btn admin" onclick="showSystem('admin')">🔧 관리자 시스템</button>
            <button class="system-btn student" onclick="showSystem('student')">👥 교육생 시스템</button>
        </div>

        <!-- 관리자 시스템 -->
        <div id="admin-system" class="system-content hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #28a745;">🔧 관리자 시스템</h2>
                <button class="btn btn-primary" onclick="showSystemSelector()">← 메인으로</button>
            </div>
            
            <div class="admin-nav">
                <button class="admin-nav-btn active" onclick="showAdminSection('course')">과정 관리</button>
                <button class="admin-nav-btn" onclick="showAdminSection('attendance')">출석 관리</button>
                <button class="admin-nav-btn" onclick="showAdminSection('data')">데이터 관리</button>
            </div>

            <!-- 과정 관리 -->
            <div id="course-section">
                <h3>과정 관리</h3>
                
                <div class="form-group">
                    <label for="course-name">과정명</label>
                    <input type="text" id="course-name" placeholder="과정명을 입력하세요">
                </div>
                
                <div class="form-group">
                    <label for="course-date">교육 날짜</label>
                    <input type="date" id="course-date">
                </div>
                
                <button class="btn btn-success" onclick="addCourse()">과정 추가</button>
                
                <table class="table">
                    <thead>
                        <tr>
                            <th>과정ID</th>
                            <th>과정명</th>
                            <th>교육 날짜</th>
                            <th>등록된 교육생 수</th>
                            <th>관리</th>
                        </tr>
                    </thead>
                    <tbody id="course-list">
                    </tbody>
                </table>
            </div>

            <!-- 출석 관리 -->
            <div id="attendance-section" class="hidden">
                <h3>출석 관리</h3>
                
                <div class="form-group">
                    <label for="select-course">과정 선택</label>
                    <select id="select-course">
                        <option value="">과정을 선택하세요</option>
                    </select>
                </div>
                
                <!-- 교육생 등록 방법 선택 -->
                <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                    <div class="file-upload" style="flex: 1;">
                        <h4>📄 Excel 파일 업로드</h4>
                        <p>이름, 사번 컬럼이 포함된 Excel 파일을 업로드하세요</p>
                        <input type="file" id="excel-file" accept=".xlsx,.xls" onchange="uploadExcel()">
                    </div>
                    
                    <div class="file-upload" style="flex: 1;">
                        <h4>✏️ 수기 입력</h4>
                        <div class="form-group" style="margin-bottom: 10px;">
                            <input type="text" id="manual-name" placeholder="이름 입력" style="margin-bottom: 8px;">
                            <input type="text" id="manual-employee-id" placeholder="사번 입력">
                        </div>
                        <button class="btn btn-primary" onclick="addStudentManually()" style="width: 100%;">교육생 추가</button>
                    </div>
                </div>
                
                <table class="table">
                    <thead>
                        <tr>
                            <th>이름</th>
                            <th>사번</th>
                            <th>입실 시간</th>
                            <th>퇴실 시간</th>
                            <th>출석 상태</th>
                            <th>관리</th>
                        </tr>
                    </thead>
                    <tbody id="attendance-list">
                    </tbody>
                </table>
            </div>

            <!-- 데이터 관리 -->
            <div id="data-section" class="hidden">
                <h3>데이터 관리</h3>
                
                <div style="background: #e8f5e8; border: 1px solid #28a745; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h4>💾 데이터 저장 상태</h4>
                    <p>모든 데이터는 자동으로 브라우저에 저장됩니다.</p>
                    <p id="save-status">✅ 데이터 저장됨</p>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-success" onclick="manualSave()">수동 저장</button>
                        <button class="btn btn-primary" onclick="manualRefresh()" style="margin-left: 10px;">강력한 새로고침</button>
                        <button class="btn btn-primary" onclick="forceSyncData()" style="margin-left: 10px;">강제 동기화</button>
                    </div>
                    <p style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                        💡 출석이 반영 안 될 때: "강력한 새로고침" 또는 "강제 동기화" 클릭
                    </p>
                </div>

                <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h4>📤 데이터 내보내기</h4>
                    <p>모든 데이터를 JSON 파일로 내보낼 수 있습니다.</p>
                    <button class="btn btn-primary" onclick="exportAllData()">전체 데이터 내보내기</button>
                </div>

                <div style="background: #f8d7da; border: 1px solid #dc3545; border-radius: 8px; padding: 20px;">
                    <h4>🗑️ 데이터 초기화</h4>
                    <p>⚠️ 주의: 모든 과정 및 출석 데이터가 삭제됩니다.</p>
                    <button class="btn btn-danger" onclick="resetAllData()">전체 데이터 초기화</button>
                </div>
            </div>
        </div>

        <!-- 교육생 시스템 -->
        <div id="student-system" class="system-content hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #007bff;">👥 교육생 출석 시스템</h2>
                <button class="btn btn-primary" onclick="showSystemSelector()">← 메인으로</button>
            </div>
            
            <div class="student-form">
                <div class="current-time" id="current-time"></div>
                
                <div id="course-info-section"></div>
                
                <div class="form-group">
                    <label for="student-name">이름</label>
                    <input type="text" id="student-name" placeholder="이름을 입력하세요">
                </div>
                
                <div class="form-group">
                    <label for="student-id">사번</label>
                    <input type="text" id="student-id" placeholder="사번을 입력하세요">
                </div>
                
                <div class="form-group">
                    <label for="attendance-type">출석 구분</label>
                    <select id="attendance-type">
                        <option value="checkin">입실</option>
                        <option value="checkout">퇴실</option>
                    </select>
                </div>
                
                <button class="btn btn-primary" onclick="markAttendance()" style="width: 100%;">출석하기</button>
                
                <div id="attendance-result"></div>
            </div>
        </div>
    </div>

    <!-- 빠른 접근 버튼 -->
    <div class="quick-access" id="quick-access" style="display: none;">
        <button class="quick-btn" onclick="showSystem('student')" title="교육생 출석">👥 출석</button>
        <button class="quick-btn" onclick="showSystem('admin')" title="관리자">🔧 관리</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // 전역 데이터 저장소
        let educationData = {
            courses: [],
            students: {},
            attendance: {},
            courseIdCounter: 1
        };

        // 데이터를 브라우저에 저장 (탭 간 동기화 강화)
        function saveDataToBrowser() {
            try {
                const dataString = JSON.stringify(educationData);
                const timestamp = new Date().getTime();
                
                console.log('=== 데이터 저장 시작 ===');
                console.log('저장할 데이터:', educationData);
                
                // 1. sessionStorage에 저장
                sessionStorage.setItem('educationSystemData', dataString);
                sessionStorage.setItem('educationSystemData_timestamp', timestamp.toString());
                console.log('✅ sessionStorage 저장 완료');
                
                // 2. localStorage에 저장 (탭 간 공유용)
                localStorage.setItem('educationSystemData', dataString);
                localStorage.setItem('educationSystemData_timestamp', timestamp.toString());
                console.log('✅ localStorage 저장 완료');
                
                // 3. 탭 간 동기화를 위한 특수 키 (storage 이벤트 트리거용)
                localStorage.setItem('educationSystemData_sync_trigger', timestamp.toString());
                
                // 4. 강제로 브라우저 저장소 동기화
                sessionStorage.setItem('educationSystemData_force', Math.random().toString());
                localStorage.setItem('educationSystemData_force', Math.random().toString());
                
                // 5. 글로벌 변수에도 저장
                window.globalEducationData = JSON.parse(JSON.stringify(educationData));
                window.globalEducationTimestamp = timestamp;
                
                // 6. BroadcastChannel을 통한 탭 간 통신 (최신 브라우저 지원)
                if (window.BroadcastChannel) {
                    if (!window.educationBroadcast) {
                        window.educationBroadcast = new BroadcastChannel('educationSystem');
                    }
                    window.educationBroadcast.postMessage({
                        type: 'dataUpdate',
                        data: educationData,
                        timestamp: timestamp
                    });
                    console.log('✅ BroadcastChannel 메시지 전송');
                }
                
                console.log('✅ 데이터 저장 완료 - 타임스탬프:', timestamp);
                
                // 데이터 변경 이벤트 발생
                window.dispatchEvent(new CustomEvent('educationDataChanged', {
                    detail: { timestamp: timestamp, data: educationData }
                }));
                
            } catch (error) {
                console.error('❌ 데이터 저장 실패:', error);
            }
        }

        // 탭 간 데이터 동기화 리스너 설정 (완전 수동 버전)
        function setupCrossTabSync() {
            console.log('🔗 탭 간 동기화 설정 중 (완전 수동)...');
            
            // 1. localStorage 변경 감지 (다른 탭에서의 변경) - 알림만 표시
            window.addEventListener('storage', function(e) {
                console.log('🔄 Storage 이벤트 감지:', e.key, e.newValue);
                
                if (e.key === 'educationSystemData_sync_trigger') {
                    console.log('🔄 다른 탭에서 데이터 변경됨');
                    
                    // 데이터만 백그라운드에서 조용히 로드 (UI 변경 없음)
                    loadDataFromBrowser();
                    
                    // 알림만 표시 (자동 새로고침 절대 안 함)
                    showUpdateAvailableNotification();
                }
                
                if (e.key === 'educationSystemData' && e.newValue) {
                    console.log('🔄 직접 데이터 변경 감지');
                    // 데이터만 백그라운드에서 조용히 동기화 (UI 변경 없음)
                    loadDataFromBrowser();
                }
            });
            
            // 2. BroadcastChannel 리스너 - 알림만 표시
            if (window.BroadcastChannel) {
                if (!window.educationBroadcast) {
                    window.educationBroadcast = new BroadcastChannel('educationSystem');
                }
                
                window.educationBroadcast.addEventListener('message', function(event) {
                    console.log('📡 BroadcastChannel 메시지 수신:', event.data);
                    
                    if (event.data.type === 'dataUpdate') {
                        // 데이터만 백그라운드에서 동기화 (UI 변경 절대 안 함)
                        educationData = JSON.parse(JSON.stringify(event.data.data));
                        window.globalEducationData = educationData;
                        window.globalEducationTimestamp = event.data.timestamp;
                        
                        console.log('🔄 BroadcastChannel을 통한 백그라운드 데이터 동기화');
                        
                        // 알림만 표시 (UI 새로고침 절대 안 함)
                        showUpdateAvailableNotification();
                    }
                });
                
                console.log('✅ BroadcastChannel 리스너 설정 완료 (수동 모드)');
            }
            
            // 3. 페이지 포커스 시에도 알림만 표시 (자동 새로고침 안 함)
            window.addEventListener('focus', function() {
                console.log('🔄 페이지 포커스 - 백그라운드 데이터 확인');
                setTimeout(() => {
                    const oldTimestamp = window.globalEducationTimestamp || 0;
                    loadDataFromBrowser(); // 데이터만 조용히 로드
                    const newTimestamp = window.globalEducationTimestamp || 0;
                    
                    if (newTimestamp > oldTimestamp) {
                        console.log('🆕 포커스 시 새로운 데이터 발견 - 알림만 표시');
                        showUpdateAvailableNotification();
                    }
                }, 200);
            });
            
            console.log('✅ 탭 간 동기화 설정 완료 (완전 수동 모드)');
        }

        // 업데이트 가능 알림 표시 (관리자 시스템에서만)
        function showUpdateAvailableNotification() {
            // 교육생 시스템에서는 알림 표시 안 함
            if (!document.getElementById('student-system').classList.contains('hidden')) {
                console.log('🚫 교육생 시스템에서는 업데이트 알림 표시 안 함');
                return;
            }
            
            // 관리자 시스템이 아닌 경우에도 알림 표시 안 함
            if (document.getElementById('admin-system').classList.contains('hidden')) {
                console.log('🚫 관리자 시스템이 활성화되지 않아 알림 표시 안 함');
                return;
            }
            
            // 기존 알림이 있으면 제거
            const existingNotice = document.getElementById('update-available-notice');
            if (existingNotice) {
                existingNotice.remove();
            }
            
            console.log('💡 관리자 시스템에 업데이트 알림 표시');
            
            const notice = document.createElement('div');
            notice.id = 'update-available-notice';
            notice.style.cssText = `
                position: fixed; top: 10px; right: 10px; 
                background: #ffc107; color: #212529; 
                padding: 15px 18px; border-radius: 10px; 
                font-size: 0.9rem; z-index: 1000;
                box-shadow: 0 6px 16px rgba(0,0,0,0.15);
                border: 2px solid #ffca2c;
                cursor: pointer;
                animation: gentleBounce 0.6s ease-out;
                max-width: 300px;
                user-select: none;
            `;
            notice.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.2em;">💡</span>
                    <div style="flex: 1;">
                        <div style="font-weight: bold; font-size: 1em;">새로운 출석 데이터</div>
                        <div style="font-size: 0.85em; margin-top: 3px; opacity: 0.8;">
                            클릭해서 확인하기 (현재 작업 유지됨)
                        </div>
                    </div>
                    <div style="font-size: 0.7rem; opacity: 0.5; margin-left: 5px;">×</div>
                </div>
            `;
            
            // CSS 애니메이션 추가
            if (!document.getElementById('gentle-bounce-style')) {
                const style = document.createElement('style');
                style.id = 'gentle-bounce-style';
                style.textContent = `
                    @keyframes gentleBounce {
                        0% { opacity: 0; transform: translateX(100%) scale(0.8); }
                        60% { opacity: 1; transform: translateX(-10px) scale(1.05); }
                        80% { transform: translateX(5px) scale(0.95); }
                        100% { opacity: 1; transform: translateX(0) scale(1); }
                    }
                    @keyframes fadeOutRight {
                        0% { opacity: 1; transform: translateX(0) scale(1); }
                        100% { opacity: 0; transform: translateX(100%) scale(0.8); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // 클릭 시에만 새로고침 (절대 자동 안 함)
            notice.addEventListener('click', function() {
                console.log('🔄 관리자 클릭 - 수동 새로고침 (상태 보존)');
                
                // 상태 보존하며 UI 새로고침
                forceRefreshAllUI();
                
                notice.remove();
                
                // 새로고침 완료 알림
                showQuickNotification('✅ 최신 출석 데이터로 업데이트 (작업 내용 유지)', '#28a745');
            });
            
            document.body.appendChild(notice);
            
            // 20초 후 자동 사라짐
            setTimeout(() => {
                if (notice.parentNode) {
                    notice.style.animation = 'fadeOutRight 0.4s ease-in';
                    setTimeout(() => {
                        if (notice.parentNode) notice.remove();
                    }, 400);
                }
            }, 20000);
        }

        // 빠른 알림 표시 (관리자 시스템에서만)
        function showQuickNotification(message, color = '#17a2b8') {
            // 교육생 시스템에서는 알림 표시 안 함
            if (!document.getElementById('student-system').classList.contains('hidden')) {
                console.log('🚫 교육생 시스템에서는 빠른 알림 표시 안 함');
                return;
            }
            
            const notice = document.createElement('div');
            notice.style.cssText = `
                position: fixed; top: 10px; right: 10px; 
                background: ${color}; color: white; 
                padding: 8px 12px; border-radius: 6px; 
                font-size: 0.8rem; z-index: 1000;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                animation: slideInRight 0.3s ease-out;
            `;
            notice.textContent = message;
            
            // CSS 애니메이션 추가
            if (!document.getElementById('quick-notice-style')) {
                const style = document.createElement('style');
                style.id = 'quick-notice-style';
                style.textContent = `
                    @keyframes slideInRight {
                        from { opacity: 0; transform: translateX(100%); }
                        to { opacity: 1; transform: translateX(0); }
                    }
                    @keyframes slideOutRight {
                        from { opacity: 1; transform: translateX(0); }
                        to { opacity: 0; transform: translateX(100%); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(notice);
            setTimeout(() => {
                notice.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => notice.remove(), 300);
            }, 2000);
        }

        // 브라우저에서 데이터 복구 (강력한 버전)
        function loadDataFromBrowser() {
            try {
                console.log('=== 데이터 로딩 시작 ===');
                
                let dataString = null;
                let source = '';
                
                // 1순위: 글로벌 변수에서 읽기
                if (window.globalEducationData) {
                    educationData = JSON.parse(JSON.stringify(window.globalEducationData));
                    window.lastDataTimestamp = window.globalEducationTimestamp || 0;
                    source = 'globalVariable';
                    console.log('✅ 글로벌 변수에서 데이터 로드 성공');
                    return true;
                }
                
                // 2순위: sessionStorage
                dataString = sessionStorage.getItem('educationSystemData');
                if (dataString) {
                    source = 'sessionStorage';
                } else {
                    // 3순위: localStorage  
                    dataString = localStorage.getItem('educationSystemData');
                    if (dataString) {
                        source = 'localStorage';
                    }
                }
                
                if (dataString) {
                    const loadedData = JSON.parse(dataString);
                    
                    // 데이터 무결성 검사
                    if (loadedData && loadedData.courses && loadedData.students && loadedData.attendance) {
                        educationData = loadedData;
                        
                        // 글로벌 변수에도 복사
                        window.globalEducationData = JSON.parse(JSON.stringify(educationData));
                        
                        // 타임스탬프 복구
                        window.lastDataTimestamp = parseInt(
                            sessionStorage.getItem('educationSystemData_timestamp') || 
                            localStorage.getItem('educationSystemData_timestamp') || 
                            '0'
                        );
                        window.globalEducationTimestamp = window.lastDataTimestamp;
                        
                        console.log(`✅ 데이터 로딩 성공 (${source}):`, educationData);
                        console.log('과정 수:', educationData.courses.length);
                        console.log('전체 출석 데이터:', educationData.attendance);
                        
                        return true;
                    } else {
                        console.error('❌ 데이터 구조가 올바르지 않습니다:', loadedData);
                    }
                } else {
                    console.log('⚠️ 저장된 데이터가 없습니다');
                }
                
                return false;
                
            } catch (error) {
                console.error('❌ 데이터 복구 실패:', error);
                return false;
            }
        }

        // 강제 데이터 동기화 (캐시 무시)
        function forceSyncData() {
            console.log('=== 강제 데이터 동기화 ===');
            
            // 현재 메모리의 데이터를 강제로 저장
            saveDataToBrowser();
            
            // 잠시 후 다시 로드하여 동기화 확인
            setTimeout(() => {
                const oldData = JSON.stringify(educationData);
                loadDataFromBrowser();
                const newData = JSON.stringify(educationData);
                
                if (oldData !== newData) {
                    console.log('🔄 데이터 동기화 확인됨');
                    forceRefreshAllUI();
                } else {
                    console.log('✅ 데이터가 이미 동기화됨');
                }
            }, 100);
        }

        // 모든 UI 강제 새로고침 (사용자 선택 상태 보존)
        function forceRefreshAllUI() {
            console.log('=== 전체 UI 강제 새로고침 (상태 보존) ===');
            
            try {
                // 현재 사용자 선택 상태 저장
                const currentStates = {
                    selectedCourse: document.getElementById('select-course')?.value || '',
                    activeAdminSection: getActiveAdminSection(),
                    currentSystem: getCurrentSystem()
                };
                
                console.log('현재 상태 저장:', currentStates);
                
                // 과정 목록 업데이트
                updateCourseList();
                console.log('과정 목록 업데이트 완료');
                
                // 과정 선택 옵션 업데이트
                updateCourseSelect();
                console.log('과정 선택 옵션 업데이트 완료');
                
                // 이전 선택 상태 복원
                if (currentStates.selectedCourse) {
                    setTimeout(() => {
                        const selectElement = document.getElementById('select-course');
                        if (selectElement) {
                            selectElement.value = currentStates.selectedCourse;
                            console.log('과정 선택 상태 복원:', currentStates.selectedCourse);
                            
                            // 출석 현황도 복원
                            if (!document.getElementById('attendance-section').classList.contains('hidden')) {
                                updateAttendanceList();
                                console.log('출석 현황 복원 완료');
                            }
                        }
                    }, 100);
                }
                
                // 교육생 화면 업데이트 (교육생 시스템이 열려있는 경우)
                if (!document.getElementById('student-system').classList.contains('hidden')) {
                    findTodayCourse();
                    console.log('교육생 화면 업데이트 완료');
                }
                
                console.log('✅ 전체 UI 새로고침 완료 (상태 보존)');
            } catch (error) {
                console.error('❌ UI 새로고침 중 오류:', error);
            }
        }

        // 현재 활성화된 관리자 섹션 확인
        function getActiveAdminSection() {
            if (!document.getElementById('attendance-section').classList.contains('hidden')) {
                return 'attendance';
            } else if (!document.getElementById('course-section').classList.contains('hidden')) {
                return 'course';
            } else if (!document.getElementById('data-section').classList.contains('hidden')) {
                return 'data';
            }
            return 'course'; // 기본값
        }

        // 현재 시스템 확인
        function getCurrentSystem() {
            if (!document.getElementById('admin-system').classList.contains('hidden')) {
                return 'admin';
            } else if (!document.getElementById('student-system').classList.contains('hidden')) {
                return 'student';
            }
            return 'main';
        }

        // 데이터 변경 감지 및 자동 새로고침 (완전 비활성화)
        function checkForDataUpdates() {
            // 모든 자동 UI 업데이트 기능 비활성화
            console.log('🚫 자동 UI 업데이트 기능 비활성화됨');
            
            // 데이터만 백그라운드에서 조용히 로드 (UI 변경 없음)
            try {
                loadDataFromBrowser();
            } catch (error) {
                console.error('백그라운드 데이터 로드 실패:', error);
            }
        }

        // URL 해시 기반 라우팅 (자동 새로고침 제거)
        function handleHashChange() {
            const hash = window.location.hash.substring(1);
            
            console.log(`=== 해시 변경: ${hash} ===`);
            
            // 해시 변경 시 데이터만 로드 (UI 자동 새로고침 제거)
            loadDataFromBrowser();
            
            if (hash === 'admin') {
                showSystem('admin');
            } else if (hash === 'student') {
                showSystem('student');
            } else {
                showSystemSelector();
            }
        }

        // 시스템 선택 화면 표시
        function showSystemSelector() {
            document.getElementById('system-selector').classList.remove('hidden');
            document.getElementById('admin-system').classList.add('hidden');
            document.getElementById('student-system').classList.add('hidden');
            document.getElementById('quick-access').style.display = 'flex';
            document.getElementById('system-badge').textContent = '시스템 선택';
            stopAdminAutoRefresh(); // 자동 갱신 중지
            window.location.hash = '';
        }

        // 시스템 전환 (완전 개선 버전)
        function showSystem(type) {
            console.log(`=== 시스템 전환: ${type} ===`);
            
            document.getElementById('system-selector').classList.add('hidden');
            document.getElementById('admin-system').classList.add('hidden');
            document.getElementById('student-system').classList.add('hidden');
            document.getElementById('quick-access').style.display = 'none';
            
            // 시스템 전환 시 무조건 최신 데이터 로드
            const dataLoaded = loadDataFromBrowser();
            console.log('데이터 로드 결과:', dataLoaded);
            
            if (type === 'admin') {
                document.getElementById('admin-system').classList.remove('hidden');
                document.getElementById('system-badge').textContent = 'Administrator';
                
                // 500ms 후 UI 강제 업데이트 (DOM 렌더링 완료 대기)
                setTimeout(() => {
                    console.log('관리자 시스템 UI 업데이트 시작');
                    forceRefreshAllUI();
                }, 500);
                
                startAdminAutoRefresh();
                window.location.hash = 'admin';
                
            } else if (type === 'student') {
                document.getElementById('student-system').classList.remove('hidden');
                document.getElementById('system-badge').textContent = 'Student Portal';
                updateCurrentTime();
                if (window.timeInterval) clearInterval(window.timeInterval);
                window.timeInterval = setInterval(updateCurrentTime, 1000);
                
                // 500ms 후 UI 강제 업데이트
                setTimeout(() => {
                    console.log('교육생 시스템 UI 업데이트 시작');
                    findTodayCourse();
                }, 500);
                
                stopAdminAutoRefresh();
                window.location.hash = 'student';
            }
        }

        // 관리자 화면 자동 갱신 시작 (완전 비활성화)
        function startAdminAutoRefresh() {
            // 모든 자동 갱신 기능 비활성화
            console.log('🚫 자동 갱신 기능 비활성화됨 - 수동 새로고침만 가능');
            
            // 기존 인터벌 정리
            if (window.adminRefreshInterval) {
                clearInterval(window.adminRefreshInterval);
                window.adminRefreshInterval = null;
            }
        }

        // 관리자 화면 자동 갱신 중지
        function stopAdminAutoRefresh() {
            if (window.adminRefreshInterval) {
                clearInterval(window.adminRefreshInterval);
                window.adminRefreshInterval = null;
                console.log('🛑 관리자 자동 갱신 중지');
            }
        }

        // 관리자 섹션 전환 (강화 버전)
        function showAdminSection(section) {
            console.log(`=== 관리자 섹션 전환: ${section} ===`);
            
            document.querySelectorAll('.admin-nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('course-section').classList.add('hidden');
            document.getElementById('attendance-section').classList.add('hidden');
            document.getElementById('data-section').classList.add('hidden');
            
            // 섹션 전환할 때마다 데이터 강제 로드
            loadDataFromBrowser();
            
            if (section === 'course') {
                document.getElementById('course-section').classList.remove('hidden');
                event.target.classList.add('active');
                setTimeout(() => {
                    updateCourseList();
                    console.log('과정 관리 화면 업데이트 완료');
                }, 200);
                
            } else if (section === 'attendance') {
                document.getElementById('attendance-section').classList.remove('hidden');
                event.target.classList.add('active');
                setTimeout(() => {
                    updateCourseSelect();
                    console.log('출석 관리 화면 - 과정 선택 업데이트 완료');
                    
                    // 과정이 이미 선택되어 있다면 출석 현황도 강제 업데이트
                    const selectedCourse = document.getElementById('select-course').value;
                    if (selectedCourse) {
                        setTimeout(() => {
                            updateAttendanceList();
                            console.log('출석 현황 강제 업데이트 완료');
                        }, 300);
                    }
                }, 200);
                
            } else if (section === 'data') {
                document.getElementById('data-section').classList.remove('hidden');
                event.target.classList.add('active');
            }
        }

        // 현재 시간 업데이트
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleString('ko-KR');
            const timeElement = document.getElementById('current-time');
            if (timeElement) {
                timeElement.textContent = `현재 시간: ${timeString}`;
            }
        }

        // 과정 추가
        function addCourse() {
            const name = document.getElementById('course-name').value;
            const date = document.getElementById('course-date').value;
            
            if (!name || !date) {
                alert('과정명과 교육 날짜를 입력하세요.');
                return;
            }
            
            const course = {
                id: educationData.courseIdCounter++,
                name: name,
                date: date,
                students: []
            };
            
            educationData.courses.push(course);
            educationData.students[course.id] = [];
            educationData.attendance[course.id] = {};
            
            document.getElementById('course-name').value = '';
            document.getElementById('course-date').value = '';
            
            updateCourseList();
            saveDataToBrowser(); // 데이터 저장
            alert('과정이 추가되었습니다.');
        }

        // 과정 목록 업데이트
        function updateCourseList() {
            const tbody = document.getElementById('course-list');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            educationData.courses.forEach(course => {
                const row = tbody.insertRow();
                const studentCount = educationData.students[course.id] ? educationData.students[course.id].length : 0;
                row.innerHTML = `
                    <td>${course.id}</td>
                    <td>${course.name}</td>
                    <td>${course.date}</td>
                    <td>${studentCount}명</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteCourse(${course.id})">삭제</button>
                    </td>
                `;
            });
        }

        // 수동 저장
        function manualSave() {
            saveDataToBrowser();
            document.getElementById('save-status').innerHTML = '✅ 수동 저장 완료 (' + new Date().toLocaleTimeString('ko-KR') + ')';
        }

        // 수동 새로고침 (상태 보존 버전)
        function manualRefresh() {
            console.log('=== 사용자 요청 - 강력한 수동 새로고침 (상태 보존) ===');
            
            // 현재 선택 상태 저장
            const selectedCourse = document.getElementById('select-course')?.value || '';
            console.log('저장된 과정 선택:', selectedCourse);
            
            // 1단계: 캐시 완전 무시하고 데이터 로드
            delete window.globalEducationData;
            delete window.globalEducationTimestamp;
            
            // 2단계: 저장소에서 강제 로드
            loadDataFromBrowser();
            
            // 3단계: UI 새로고침 (상태 보존)
            setTimeout(() => {
                forceRefreshAllUI();
                console.log('✅ 강력한 새로고침 완료 (상태 보존)');
                
                // 새로고침 완료 알림
                const notice = document.createElement('div');
                notice.style.cssText = `
                    position: fixed; top: 10px; right: 10px; 
                    background: #007bff; color: white; 
                    padding: 8px 12px; border-radius: 5px; 
                    font-size: 0.8rem; z-index: 1000;
                `;
                notice.textContent = '✅ 강력한 새로고침 완료 (선택 상태 유지)';
                document.body.appendChild(notice);
                setTimeout(() => notice.remove(), 3000);
            }, 200);
        }

        // 전체 데이터 내보내기
        function exportAllData() {
            try {
                const dataString = JSON.stringify(educationData, null, 2);
                const blob = new Blob([dataString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `교육관리시스템_백업_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('데이터 내보내기가 완료되었습니다.');
            } catch (error) {
                alert('데이터 내보내기 중 오류가 발생했습니다.');
                console.error(error);
            }
        }

        // 전체 데이터 초기화
        function resetAllData() {
            if (confirm('⚠️ 정말로 모든 데이터를 초기화하시겠습니까?\n이 작업은 되돌릴 수 없습니다.')) {
                if (confirm('⚠️ 마지막 확인: 모든 과정, 교육생, 출석 데이터가 삭제됩니다. 계속하시겠습니까?')) {
                    // 브라우저 저장소도 함께 초기화
                    sessionStorage.removeItem('educationSystemData');
                    localStorage.removeItem('educationSystemData');
                    
                    educationData = {
                        courses: [],
                        students: {},
                        attendance: {},
                        courseIdCounter: 1
                    };
                    
                    updateCourseList();
                    updateCourseSelect();
                    updateAttendanceList();
                    findTodayCourse();
                    saveDataToBrowser();
                    
                    alert('✅ 모든 데이터가 초기화되었습니다.');
                }
            }
        }

        // 과정 삭제
        function deleteCourse(courseId) {
            if (confirm('정말로 이 과정을 삭제하시겠습니까?')) {
                educationData.courses = educationData.courses.filter(course => course.id !== courseId);
                delete educationData.students[courseId];
                delete educationData.attendance[courseId];
                updateCourseList();
                updateCourseSelect();
                saveDataToBrowser(); // 데이터 저장
            }
        }

        // 과정 선택 옵션 업데이트
        function updateCourseSelect() {
            const select = document.getElementById('select-course');
            if (!select) return;
            
            select.innerHTML = '<option value="">과정을 선택하세요</option>';
            
            educationData.courses.forEach(course => {
                const option = document.createElement('option');
                option.value = course.id;
                option.textContent = `${course.name} (${course.date})`;
                select.appendChild(option);
            });
        }

        // 수기로 교육생 추가
        function addStudentManually() {
            const courseId = document.getElementById('select-course').value;
            const name = document.getElementById('manual-name').value.trim();
            const employeeId = document.getElementById('manual-employee-id').value.trim();
            
            if (!courseId) {
                alert('먼저 과정을 선택하세요.');
                return;
            }
            
            if (!name || !employeeId) {
                alert('이름과 사번을 모두 입력하세요.');
                return;
            }
            
            // 중복 확인
            if (educationData.attendance[courseId] && educationData.attendance[courseId][employeeId]) {
                alert('이미 등록된 사번입니다.');
                return;
            }
            
            // 학생 배열 초기화 (없는 경우)
            if (!educationData.students[courseId]) {
                educationData.students[courseId] = [];
            }
            if (!educationData.attendance[courseId]) {
                educationData.attendance[courseId] = {};
            }
            
            // 학생 추가
            const newStudent = {
                name: name,
                employeeId: employeeId
            };
            
            educationData.students[courseId].push(newStudent);
            educationData.attendance[courseId][employeeId] = {
                name: name,
                employeeId: employeeId,
                checkinTime: null,
                checkoutTime: null
            };
            
            // 입력 필드 초기화
            document.getElementById('manual-name').value = '';
            document.getElementById('manual-employee-id').value = '';
            
            updateCourseList();
            updateAttendanceList();
            saveDataToBrowser(); // 데이터 저장
            alert(`${name}(${employeeId}) 교육생이 추가되었습니다.`);
        }

        // Excel 파일 업로드
        function uploadExcel() {
            const file = document.getElementById('excel-file').files[0];
            const courseId = document.getElementById('select-course').value;
            
            if (!courseId) {
                alert('먼저 과정을 선택하세요.');
                return;
            }
            
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                
                const studentList = [];
                const duplicates = [];
                
                jsonData.forEach(row => {
                    if (row['이름'] && row['사번']) {
                        const employeeId = row['사번'].toString();
                        const name = row['이름'].toString();
                        
                        // 중복 확인
                        if (educationData.attendance[courseId] && educationData.attendance[courseId][employeeId]) {
                            duplicates.push(`${name}(${employeeId})`);
                        } else {
                            studentList.push({
                                name: name,
                                employeeId: employeeId
                            });
                        }
                    }
                });
                
                // 기존 학생 배열 유지하고 새로운 학생 추가
                if (!educationData.students[courseId]) {
                    educationData.students[courseId] = [];
                }
                if (!educationData.attendance[courseId]) {
                    educationData.attendance[courseId] = {};
                }
                
                // 새로운 학생들 추가
                studentList.forEach(student => {
                    educationData.students[courseId].push(student);
                    educationData.attendance[courseId][student.employeeId] = {
                        name: student.name,
                        employeeId: student.employeeId,
                        checkinTime: null,
                        checkoutTime: null
                    };
                });
                
                updateCourseList();
                updateAttendanceList();
                saveDataToBrowser(); // 데이터 저장
                
                let message = `${studentList.length}명의 교육생이 추가되었습니다.`;
                if (duplicates.length > 0) {
                    message += `\n\n중복으로 제외된 교육생 (${duplicates.length}명):\n${duplicates.join(', ')}`;
                }
                alert(message);
            };
            
            reader.readAsArrayBuffer(file);
        }

        // 교육생 삭제
        function removeStudent(courseId, employeeId) {
            if (confirm('정말로 이 교육생을 삭제하시겠습니까?')) {
                // students 배열에서 제거
                if (educationData.students[courseId]) {
                    educationData.students[courseId] = educationData.students[courseId].filter(
                        student => student.employeeId !== employeeId
                    );
                }
                
                // attendance 객체에서 제거
                if (educationData.attendance[courseId]) {
                    delete educationData.attendance[courseId][employeeId];
                }
                
                updateCourseList();
                updateAttendanceList();
                saveDataToBrowser(); // 데이터 저장
                alert('교육생이 삭제되었습니다.');
            }
        }

        // 출석 현황 업데이트 (로깅 강화, 자동 갱신 없음)
        function updateAttendanceList() {
            const courseId = document.getElementById('select-course').value;
            const tbody = document.getElementById('attendance-list');
            if (!tbody) {
                console.log('⚠️ 출석 테이블 요소를 찾을 수 없음');
                return;
            }
            
            tbody.innerHTML = '';
            
            if (!courseId || !educationData.attendance[courseId]) {
                console.log('⚠️ 선택된 과정이 없거나 출석 데이터가 없음');
                return;
            }
            
            const students = Object.values(educationData.attendance[courseId]);
            console.log(`📊 출석 현황 수동 업데이트: 과정 ${courseId}, 학생 ${students.length}명`);
            
            students.forEach(student => {
                const row = tbody.insertRow();
                const checkinTime = student.checkinTime ? new Date(student.checkinTime).toLocaleTimeString('ko-KR') : '-';
                const checkoutTime = student.checkoutTime ? new Date(student.checkoutTime).toLocaleTimeString('ko-KR') : '-';
                
                let status = '미출석';
                let statusColor = '#6c757d';
                let statusIcon = '⭕';
                
                if (student.checkinTime && student.checkoutTime) {
                    status = '출석완료';
                    statusColor = '#28a745';
                    statusIcon = '✅';
                } else if (student.checkinTime) {
                    status = '입실완료';
                    statusColor = '#007bff';
                    statusIcon = '🔵';
                }
                
                row.innerHTML = `
                    <td>${student.name}</td>
                    <td>${student.employeeId}</td>
                    <td style="font-weight: bold;">${checkinTime}</td>
                    <td style="font-weight: bold;">${checkoutTime}</td>
                    <td style="color: ${statusColor}; font-weight: bold; font-size: 1.1em;">${statusIcon} ${status}</td>
                    <td>
                        <button class="btn btn-danger" onclick="removeStudent('${courseId}', '${student.employeeId}')" style="font-size: 0.8rem; padding: 5px 10px;">삭제</button>
                    </td>
                `;
            });
            
            // 수동 업데이트 완료 로그
            const updateTime = new Date().toLocaleTimeString('ko-KR');
            console.log(`✅ 출석 현황 수동 업데이트 완료: ${updateTime}`);
        }

        // 오늘 진행되는 과정 찾기
        function findTodayCourse() {
            const today = new Date().toISOString().split('T')[0];
            const todayCourse = educationData.courses.find(course => course.date === today);
            
            const courseInfoSection = document.getElementById('course-info-section');
            
            if (todayCourse) {
                const studentCount = educationData.students[todayCourse.id] ? educationData.students[todayCourse.id].length : 0;
                courseInfoSection.innerHTML = `
                    <div class="course-info">
                        <h3>📚 오늘의 교육과정</h3>
                        <p><strong>${todayCourse.name}</strong></p>
                        <p>📅 ${todayCourse.date} | 👥 등록인원: ${studentCount}명</p>
                    </div>
                `;
            } else {
                courseInfoSection.innerHTML = `
                    <div class="course-info" style="background: #fff3cd; border-color: #ffeaa7;">
                        <h3 style="color: #856404;">📅 안내</h3>
                        <p style="color: #856404;">오늘 진행되는 교육과정이 없습니다.</p>
                        <p style="color: #856404; font-size: 0.9rem; margin-top: 5px;">관리자에게 문의하세요.</p>
                    </div>
                `;
            }
        }

        // 과정 선택 변경 시 출석 현황 업데이트 (강화 버전)
        document.addEventListener('change', function(e) {
            if (e.target && e.target.id === 'select-course') {
                console.log('=== 과정 선택 변경 ===');
                
                // 과정 선택 시 무조건 최신 데이터 강제 로드
                loadDataFromBrowser();
                
                setTimeout(() => {
                    updateAttendanceList();
                    console.log('과정 선택 변경 - 출석 현황 업데이트 완료');
                }, 200);
            }
        });

        // 교육생 출석 처리 (강력한 데이터 동기화)
        function markAttendance() {
            const name = document.getElementById('student-name').value.trim();
            const employeeId = document.getElementById('student-id').value.trim();
            const type = document.getElementById('attendance-type').value;
            
            if (!name || !employeeId) {
                showAttendanceResult('이름과 사번을 모두 입력하세요.', 'error');
                return;
            }
            
            // 최신 데이터 강제 로드
            loadDataFromBrowser();
            
            // 오늘 날짜와 일치하는 과정 찾기
            const today = new Date().toISOString().split('T')[0];
            const todayCourse = educationData.courses.find(course => course.date === today);
            
            if (!todayCourse) {
                showAttendanceResult('오늘 진행되는 교육과정이 없습니다.', 'error');
                return;
            }
            
            // 교육생 확인
            if (!educationData.attendance[todayCourse.id] || !educationData.attendance[todayCourse.id][employeeId]) {
                showAttendanceResult('등록되지 않은 교육생입니다.', 'error');
                return;
            }
            
            const student = educationData.attendance[todayCourse.id][employeeId];
            
            // 이름 확인
            if (student.name !== name) {
                showAttendanceResult('이름이 일치하지 않습니다.', 'error');
                return;
            }
            
            const now = new Date();
            
            if (type === 'checkin') {
                if (student.checkinTime) {
                    showAttendanceResult('이미 입실 처리되었습니다.', 'error');
                    return;
                }
                student.checkinTime = now.toISOString();
                showAttendanceResult(`입실 완료! (${now.toLocaleTimeString('ko-KR')})`, 'success');
                console.log(`[출석] ${name}(${employeeId}) 입실 완료`);
            } else {
                if (!student.checkinTime) {
                    showAttendanceResult('입실 처리가 되지 않았습니다.', 'error');
                    return;
                }
                if (student.checkoutTime) {
                    showAttendanceResult('이미 퇴실 처리되었습니다.', 'error');
                    return;
                }
                student.checkoutTime = now.toISOString();
                showAttendanceResult(`퇴실 완료! (${now.toLocaleTimeString('ko-KR')})`, 'success');
                console.log(`[출석] ${name}(${employeeId}) 퇴실 완료`);
            }
            
            // 입력 필드 초기화
            document.getElementById('student-name').value = '';
            document.getElementById('student-id').value = '';
            
            console.log('=== 출석 처리 후 데이터 저장 ===');
            console.log('저장 전 데이터:', educationData.attendance[todayCourse.id][employeeId]);
            
            // 강력한 데이터 저장 및 동기화
            saveDataToBrowser();
            
            // 추가로 강제 동기화
            setTimeout(() => {
                forceSyncData();
                console.log('출석 처리 완료 및 데이터 동기화');
            }, 100);
        }

        // 출석 결과 표시
        function showAttendanceResult(message, type) {
            const resultDiv = document.getElementById('attendance-result');
            if (!resultDiv) return;
            
            resultDiv.className = `attendance-status status-${type}`;
            resultDiv.textContent = message;
            
            // 3초 후 메시지 제거
            setTimeout(() => {
                resultDiv.textContent = '';
                resultDiv.className = '';
            }, 3000);
        }

        // 초기 설정 및 이벤트 리스너 (탭 간 동기화 추가)
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 === 페이지 초기화 시작 ===');
            
            // 1단계: 저장된 데이터 복구
            const dataLoaded = loadDataFromBrowser();
            if (dataLoaded) {
                console.log('✅ 저장된 데이터 복구 성공');
            } else {
                console.log('⚠️ 저장된 데이터 없음 - 새로 시작');
            }
            
            // 2단계: 탭 간 동기화 설정
            setupCrossTabSync();
            
            // 3단계: 기존 이벤트 리스너 등록
            
            // 글로벌 데이터 변경 이벤트 리스너
            window.addEventListener('educationDataChanged', function(event) {
                console.log('🔄 데이터 변경 이벤트 수신:', event.detail);
                // 자동 UI 새로고침 제거
            });
            
            // 4단계: 해시 변경 이벤트 리스너 및 초기 라우팅
            window.addEventListener('hashchange', handleHashChange);
            
            // 5단계: 초기 해시 처리 (지연 실행으로 DOM 완성 대기)
            setTimeout(() => {
                console.log('🎯 초기 라우팅 시작');
                handleHashChange();
                
                // 기본 페이지 설정
                if (!window.location.hash) {
                    showSystemSelector();
                }
                
            }, 300);
            
            // 6단계: 기타 이벤트 리스너
            
            // 페이지 종료 시 정리
            window.addEventListener('beforeunload', function() {
                saveDataToBrowser();
                stopAdminAutoRefresh();
                
                // BroadcastChannel 정리
                if (window.educationBroadcast) {
                    window.educationBroadcast.close();
                }
            });
            
            // 주기적 자동 저장 (30초마다)
            setInterval(function() {
                saveDataToBrowser();
            }, 30000);
            
            // 주기적 탭 간 동기화 확인 (완전 비활성화)
            // 모든 자동 새로고침 기능 비활성화
            console.log('🚫 모든 주기적 자동 새로고침 기능 비활성화');
            
            // 엔터 키 이벤트 (교육생 시스템용)
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !document.getElementById('student-system').classList.contains('hidden')) {
                    const activeElement = document.activeElement;
                    if (activeElement.id === 'student-name') {
                        document.getElementById('student-id').focus();
                    } else if (activeElement.id === 'student-id') {
                        document.getElementById('attendance-type').focus();
                    } else if (activeElement.id === 'attendance-type') {
                        markAttendance();
                    }
                }
            });
            
            console.log('🎉 === 페이지 초기화 완료 ===');
        });
    </script>
</body>
</html>
